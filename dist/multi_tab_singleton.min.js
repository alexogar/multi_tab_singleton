/*! multi_tab_singleton 15-06-2014 */
!function(a,b){"use strict";var c=function(a,c,d){var e=Object.prototype.toString,f={heartBeat:50,heartBeatTimeout:50,forseMaster:!1,singletonFunctionExecution:!0};(null===d||d===b)&&(d={});var g={};for(var h in f)g[h]=d[h]||f[h];var i=function(a,b){for(var c in a)"object"==typeof a[c]&&null!==a[c]&&b[c]?i(b[c],a[c]):b[c]=a[c]},j=function(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;5>c;c++)a+=b.charAt(Math.floor(Math.random()*b.length));return a},k=function(a,b,c){var d,f,g=c||[],h=0;"[object Array]"===e.call(a)&&a.forEach(function(c){f=e.call(c),d="[object Object]"===f||"[object Array]"===f?k(c,b,g.concat(h)):b(g.concat(h),c,a),d&&(a[h]=d),h++});for(var i in a)(""+i).match(/^\d+$/)||(f=e.call(a[i]),d="[object Object]"===f||"[object Array]"===f?k(a[i],b,g.concat(i)):b(g.concat(i),a[i],a),d&&(a[i]=d));return a},l={_s:null,init:function(){if(this._s=window.$.jStorage||window.jStorage,null===this._s)throw new ReferenceError("Error referencing jStorage, include jStorage or use full distribution")},get:function(a,b){return this._s.get(a,b)},set:function(a,b){this._s.set(a,b)},subscribeToChanges:function(a,b){this._s.listenKeyChange(a,b)},subscribe:function(a,b){this._s.subscribe(a,b)},publish:function(a,b){this._s.publish(a,b)},del:function(a){this._s.deleteKey(a)}};if(l.init(),null===ObjectObserver)throw new ReferenceError("observer-js is not exists");var m={_o:null,_obj:null,init:function(a){if(null===a)throw new ReferenceError("Object should not be null");if(this._obj=a,null===ObjectObserver)throw new ReferenceError("observer-js is not exists");this._o=new ObjectObserver(this._obj);var b=this;this._o.open(function(){b._obj.saveValues()})},close:function(){this._o.close()}},n={id:j(),master:!1,lastAccessedTime:(new Date).getTime()},o=function(){var b=l.get(a+"_participants",[]),c=[];for(var d in b){var e=b[d],f=(new Date).getTime();e.lastAccessedTime>f-g.heartBeat&&e.id!==n.id&&c.push(e)}var h=null;for(var i in c){var j=c[i];j.master&&h?j.master=!1:j.master&&(h=j)}return null===h&&(n.master=!0),n.lastAccessedTime=(new Date).getTime(),c.push(n),l.del(a+"_participants"),l.set(a+"_participants",c),n};if(c=k(c,function(b,d,e){if("function"==typeof d){var f=function(){var f=Array.prototype.slice.call(arguments),g=f[f.length-1];if(c.api.master){var h=d.apply(e,f),i=[];i.push(h),g&&g.apply(e,i)}else{var k={};k.id=j(),k.params=f,k.name=b,c.api.results[k.id]=g,l.publish(a+"_function_calls",k)}};return f.origin=d,f}}),n=o(),n.results={},c.loadValues=function(){var b=l.get(a+"_value");b&&i(b,this)},c.saveValues=function(){l.set(a+"_value",this)},c.subscribe=function(){var b=this;l.subscribeToChanges(a+"_value",function(){b.loadValues()}),l.subscribe(a+"_function_calls",function(c,d){if(b.api.master){var e=d.id,f=d.name,g=d.params,h=b,i=b;for(var j in f)if(i=h,h=i[f[j]],null===h)break;if(h){var k=h.origin.apply(i,g);l.publish(a+"_function_results",{id:e,result:k})}}}),l.subscribe(a+"_function_results",function(a,b){var d=b.id;if(c.api.results[d]){var e=b.result,f=[];f.push(e),c.api.results[d].apply(c,f),delete c.api.resuls[d]}})},n.id=j(),c.substituteFunctionsInObject=k,c.api=n,c.api.master&&c.saveValues(),c.loadValues(),m.init(c),null===Object.observe||Object.observe===b){var p=function(){Platform.performMicrotaskCheckpoint(),n=o(),setTimeout(p,g.heartBeatTimeout)};p()}return c.subscribe(),m._obj};c.VERSION="0.0.1",a.MultiTabSingleton=c}(this);